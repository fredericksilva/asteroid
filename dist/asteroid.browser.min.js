!function(t,e){if("function"==typeof define&&define.amd)define(["ddp.js","q"],e);else if("object"==typeof exports){var i=require("ddp.js"),o=require("q");module.exports=e(i,o)}else t.Asteroid=e(t.DDP,t.Q)}(this,function(t,e){"use strict";var i=function(t,e,o,n){i.utils.must.beString(t),this._instanceId=n||"0",this._host=(e?"https://":"http://")+t,this.collections={},this.subscriptions={},this._subscriptionsCache={},this._setDdpOptions(t,e,o),this._init()};i.utils||(i.utils={}),i.utils.btoa=function(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=function(e){return t.charAt(e)},i=function(t){for(var e=[],i=0;t>i;i++)e.push(0);return e};return function(t){if("string"==typeof t){var o=t;t=i(o.length);for(var n=0;n<o.length;n++){var r=o.charCodeAt(n);if(r>255)throw new Error("Not ascii. Base64.encode can only take ascii strings");t[n]=r}}for(var s=[],u=null,l=null,c=null,d=null,a=0;a<t.length;a++)switch(a%3){case 0:u=t[a]>>2&63,l=(3&t[a])<<4;break;case 1:l|=t[a]>>4&15,c=(15&t[a])<<2;break;case 2:c|=t[a]>>6&3,d=63&t[a],s.push(e(u)),s.push(e(l)),s.push(e(c)),s.push(e(d)),u=null,l=null,c=null,d=null}return null!==u&&(s.push(e(u)),s.push(e(l)),s.push(null===c?"=":e(c)),null===d&&s.push("=")),s.join("")}}(),i.utils||(i.utils={}),i.utils.clone=function(t){if("undefined"!=typeof EJSON)return EJSON.clone(t);var e=typeof t;switch(e){case"undefined":case"function":return void 0;case"string":case"number":case"boolean":return t;case"object":return null===t?null:JSON.parse(JSON.stringify(t));default:return}},i.utils||(i.utils={}),i.utils.EventEmitter=function(){},i.utils.EventEmitter.prototype={constructor:i.utils.EventEmitter,on:function(t,e){this._events||(this._events={}),this._events[t]=this._events[t]||[],this._events[t].push(e)},off:function(t,e){this._events||(this._events={}),this._events[t]&&this._events[t].splice(this._events[t].indexOf(e),1)},_emit:function(t){if(this._events||(this._events={}),this._events[t]){var e=arguments,i=this;this._events[t].forEach(function(t){t.apply(i,Array.prototype.slice.call(e,1))})}}},i.utils||(i.utils={}),i.utils.getFilterFromSelector=function(t){var e=function(t,e){return e.split(".").reduce(function(t,e){return t?t=t[e]:t},t)},o=Object.keys(t),n=o.map(function(o){var n;return"$and"===o?(n=t[o].map(i.utils.getFilterFromSelector),function(t){return n.reduce(function(e,i){return e?i(t):e},!0)}):"$or"===o?(n=t[o].map(i.utils.getFilterFromSelector),function(t){return n.reduce(function(e,i){return e?e:i(t)},!1)}):"$nor"===o?(n=t[o].map(i.utils.getFilterFromSelector),function(t){return n.reduce(function(e,i){return e?!i(t):e},!0)}):function(i){var n=e(i,o);return n===t[o]}});return function(t){return t._id&&r(t._id)?!1:n.reduce(function(e,i){return e?i(t):e},!0)}},i.utils||(i.utils={}),i.utils.formQs=function(t){var e="";for(var i in t)t.hasOwnProperty(i)&&(e+=encodeURIComponent(i)+"="+encodeURIComponent(t[i])+"&");return e=e.slice(0,-1)},i.utils||(i.utils={}),i.utils.getOauthState=function(t){var e={loginStyle:"popup",credentialToken:t,isCordova:!1};return i.utils.btoa(JSON.stringify(e))},i.utils||(i.utils={}),i.utils.guid=function(){for(var t="",e=0;8>e;e++)t+=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return t},i.utils||(i.utils={}),i.utils.isEmail=function(t){return-1!==t.indexOf("@")},i.utils||(i.utils={}),i.utils.isEqual=function(t,e){var i=JSON.stringify(t),o=JSON.stringify(e);return i===o},i.utils||(i.utils={}),i.utils.multiStorage={},i.utils||(i.utils={}),i.utils.must={_toString:function(t){return Object.prototype.toString.call(t).slice(8,-1)},beString:function(t){var e=this._toString(t);if("String"!==e)throw new Error("Assertion failed: expected String, instead got "+e)},beArray:function(t){var e=this._toString(t);if("Array"!==e)throw new Error("Assertion failed: expected Array, instead got "+e)},beObject:function(t){var e=this._toString(t);if("Object"!==e)throw new Error("Assertion failed: expected Object, instead got "+e)}},i.prototype=Object.create(i.utils.EventEmitter.prototype),i.prototype.constructor=i,i.prototype._init=function(){var e=this;e.ddp=new t(this._ddpOptions),e.ddp.on("connected",function(){e.resumeLoginPromise=e._tryResumeLogin(),e.subscribe("meteor.loginServiceConfiguration"),e._emit("connected")}),e.ddp.on("reconnected",function(){e.resumeLoginPromise=e._tryResumeLogin(),e._reEstablishSubscriptions(),e._emit("reconnected")}),e.ddp.on("added",function(t){e._onAdded(t)}),e.ddp.on("changed",function(t){e._onChanged(t)}),e.ddp.on("removed",function(t){e._onRemoved(t)})},i.prototype._onAdded=function(t){var e=t.collection;this.collections[e]||(this.collections[e]=new i._Collection(e,this));var o=t.fields||{};o._id=t.id,this.collections[e]._remoteToLocalInsert(o)},i.prototype._onRemoved=function(t){this.collections[t.collection]&&this.collections[t.collection]._remoteToLocalRemove(t.id)},i.prototype._onChanged=function(t){this.collections[t.collection]&&(t.fields||(t.fields={}),t.cleared&&t.cleared.forEach(function(e){t.fields[e]=void 0}),this.collections[t.collection]._remoteToLocalUpdate(t.id,t.fields))},i.prototype.call=function(t){i.utils.must.beString(t);var e=Array.prototype.slice.call(arguments,1);return this.apply(t,e)},i.prototype.apply=function(t,o){i.utils.must.beString(t),Array.isArray(o)||(o=[]);var n=e.defer(),r=e.defer(),s=function(t,e){t?(n.reject(t),r.reject()):n.resolve(e)},u=function(){r.resolve()};return this.ddp.method(t,o,s,u),{result:n.promise,updated:r.promise}},i.prototype.getCollection=function(t){return i.utils.must.beString(t),this.collections[t]||(this.collections[t]=new i._Collection(t,this)),this.collections[t]};var o="__del__",n="__upd__",r=function(t){var e=o.length,i=n.length,r=t.slice(-1*e),s=t.slice(-1*i);return r===o||s===n},s=function(t,e){this.name=t,this.asteroid=e,this._set=new l};s.prototype.constructor=s,s.prototype._localToLocalInsert=function(t){if(this._set.contains(t._id))throw new Error("Item "+t._id+" already exists");return this._set.put(t._id,t),e(t._id)},s.prototype._remoteToLocalInsert=function(t){this._set.put(t._id,t)},s.prototype._localToRemoteInsert=function(t){var i=this,o=e.defer(),n="/"+i.name+"/insert";return i.asteroid.ddp.method(n,[t],function(e){e?(i._set.del(t._id),o.reject(e)):o.resolve(t._id)}),o.promise},s.prototype.insert=function(t){return t._id||(t._id=i.utils.guid()),{local:this._localToLocalInsert(t),remote:this._localToRemoteInsert(t)}},s.prototype._localToLocalRemove=function(t){var i=this._set.get(t);return i&&(this._set.put(t+o,i),this._set.del(t)),e(t)},s.prototype._remoteToLocalRemove=function(t){this._set.del(t)},s.prototype._localToRemoteRemove=function(t){var i=this,n=e.defer(),r="/"+i.name+"/remove";return i.asteroid.ddp.method(r,[{_id:t}],function(e){if(e){var r=i._set.get(t+o);r&&(i._set.put(t,r),i._set.del(t+o)),n.reject(e)}else i._set.del(t+o),n.resolve(t)}),n.promise},s.prototype.remove=function(t){return{local:this._localToLocalRemove(t),remote:this._localToRemoteRemove(t)}},s.prototype._localToLocalUpdate=function(t,i){var o=this._set.get(t);if(!o)throw new Error("Item "+t+" doesn't exist");if(i._id&&i._id!==t)throw new Error("Modifying the _id of a document is not allowed");this._set.put(t+n,o);for(var r in i)i.hasOwnProperty(r)&&(o[r]=i[r]);return this._set.put(t,o),e(t)},s.prototype._remoteToLocalUpdate=function(t,e){var i=this._set.get(t);if(!i)return void console.warn("Server misbehaviour: item "+t+" doesn't exist");for(var o in e){if("_id"===o&&e._id!==t)return void console.warn("Server misbehaviour: modifying the _id of a document is not allowed");i[o]=e[o]}this._set.put(t,i)},s.prototype._localToRemoteUpdate=function(t,i){var o=this,r=e.defer(),s="/"+o.name+"/update",u={_id:t},l={$set:i};return o.asteroid.ddp.method(s,[u,l],function(e){if(e){var i=o._set.get(t+n);o._set.put(t,i),o._set.del(t+n),r.reject(e)}else o._set.del(t+n),r.resolve(t)}),r.promise},s.prototype.update=function(t,e){return{local:this._localToLocalUpdate(t,e),remote:this._localToRemoteUpdate(t,e)}};var u=function(t){var e=this;e.result=[],e._set=t,e._getResult(),e._set.on("put",function(t){e._getResult(),e._emit("change",t)}),e._set.on("del",function(t){e._getResult(),e._emit("change",t)})};u.prototype=Object.create(i.utils.EventEmitter.prototype),u.constructor=u,u.prototype._getResult=function(){this.result=this._set.toArray()},s.prototype.reactiveQuery=function(t){var e;e="function"==typeof t?t:i.utils.getFilterFromSelector(t);var o=this._set.filter(e);return new u(o)},i._Collection=s,i.prototype._getOauthClientId=function(t){var e="meteor_accounts_loginServiceConfiguration",i=this.collections[e],o=i.reactiveQuery({service:t}).result[0];return o.clientId||o.consumerKey||o.appId},i.prototype._loginAfterCredentialSecretReceived=function(t){var o=this,n=e.defer(),r={oauth:t};return o.ddp.method("login",[r],function(t,e){t?(delete o.userId,delete o.loggedIn,i.utils.multiStorage.del(o._host+"__"+o._instanceId+"__login_token__"),n.reject(t),o._emit("loginError",t)):(o.userId=e.id,o.loggedIn=!0,i.utils.multiStorage.set(o._host+"__"+o._instanceId+"__login_token__",e.token),o._emit("login",e.id),n.resolve(e.id))}),n.promise},i.prototype._connectAfterCredentialSecretReceived=function(t){var i=e.defer(),o={oauth:t};return this.ddp.method("addLoginService",[o],function(t){t?i.reject(t):i.resolve()}),i.promise},i.prototype._tryResumeLogin=function(){var t=this;return e().then(function(){return i.utils.multiStorage.get(t._host+"__"+t._instanceId+"__login_token__")}).then(function(t){if(!t)throw new Error("No login token");return t}).then(function(o){var n=e.defer(),r={resume:o};return t.ddp.method("login",[r],function(e,o){e?(delete t.userId,delete t.loggedIn,i.utils.multiStorage.del(t._host+"__"+t._instanceId+"__login_token__"),t._emit("loginError",e),n.reject(e)):(t.userId=o.id,t.loggedIn=!0,i.utils.multiStorage.set(t._host+"__"+t._instanceId+"__login_token__",o.token),t._emit("login",o.id),n.resolve(o.id))}),n.promise})},i.prototype.createUser=function(t,o,n){var r,s=this,u=e.defer();return"string"==typeof t?r={username:i.utils.isEmail(t)?void 0:t,email:i.utils.isEmail(t)?t:void 0,password:o,profile:n}:"object"==typeof t&&(r=t),s.ddp.method("createUser",[r],function(t,e){t?(s._emit("createUserError",t),u.reject(t)):(s.userId=e.id,s.loggedIn=!0,i.utils.multiStorage.set(s._host+"__"+s._instanceId+"__login_token__",e.token),s._emit("createUser",e.id),s._emit("login",e.id),u.resolve(e.id))}),u.promise},i.prototype.loginWithPassword=function(t,o){var n=this,r=e.defer(),s={password:o,user:{username:i.utils.isEmail(t)?void 0:t,email:i.utils.isEmail(t)?t:void 0}};return n.ddp.method("login",[s],function(t,e){t?(delete n.userId,delete n.loggedIn,i.utils.multiStorage.del(n._host+"__"+n._instanceId+"__login_token__"),r.reject(t),n._emit("loginError",t)):(n.userId=e.id,n.loggedIn=!0,i.utils.multiStorage.set(n._host+"__"+n._instanceId+"__login_token__",e.token),n._emit("login",e.id),r.resolve(e.id))}),r.promise},i.prototype.logout=function(){var t=this,o=e.defer();return t.ddp.method("logout",[],function(e){e?(t._emit("logoutError",e),o.reject(e)):(delete t.userId,delete t.loggedIn,i.utils.multiStorage.del(t._host+"__"+t._instanceId+"__login_token__"),t._emit("logout"),o.resolve())}),o.promise};var l=function(t){t&&(this._put=this.put,this._del=this.del,this.put=this.del=function(){throw new Error("Attempt to modify readonly set")}),this._items={}};l.prototype=Object.create(i.utils.EventEmitter.prototype),l.constructor=l,l.prototype.put=function(t,e){return i.utils.must.beString(t),i.utils.must.beObject(e),this._items[t]=i.utils.clone(e),this._emit("put",t),this},l.prototype.del=function(t){return i.utils.must.beString(t),delete this._items[t],this._emit("del",t),this},l.prototype.get=function(t){return i.utils.must.beString(t),i.utils.clone(this._items[t])},l.prototype.contains=function(t){return i.utils.must.beString(t),!!this._items[t]},l.prototype.filter=function(t){var e=new l(!0),o=this._items,n=Object.keys(o);return n.forEach(function(n){var r=i.utils.clone(o[n]),s=t(r);s&&(e._items[n]=o[n])}),this.on("put",function(n){var r=i.utils.clone(o[n]),s=t(r);s&&e._put(n,o[n])}),this.on("del",function(t){e._del(t)}),e},l.prototype.toArray=function(){var t=[],e=this._items,o=Object.keys(this._items);return o.forEach(function(i){t.push(e[i])}),i.utils.clone(t)},l.prototype.toHash=function(){return i.utils.clone(this._items)},i.Set=l;var c=function(t,i,o,n){this._name=t,this._params=i,this._fingerprint=o,this._asteroid=n,this._ready=e.defer(),this.ready=this._ready.promise;var r=this._onReady.bind(this),s=this._onStop.bind(this),u=this._onError.bind(this);this.id=n.ddp.sub(t,i,r,s,u)};return c.constructor=c,c.prototype.stop=function(){this._asteroid.ddp.unsub(this.id),delete this._asteroid._subscriptionsCache[this._fingerprint]},c.prototype._onReady=function(){this._ready.resolve(this.id)},c.prototype._onStop=function(){delete this._asteroid.subscriptions[this.id],delete this._asteroid._subscriptionsCache[this._fingerprint]},c.prototype._onError=function(t){this.ready.isPending()&&this._ready.reject(t),delete this._asteroid.subscriptions[this.id],delete this._asteroid._subscriptionsCache[this._fingerprint]},i.prototype.subscribe=function(t){i.utils.must.beString(t);var e=Array.prototype.slice.call(arguments),o=JSON.stringify(e);if(!this._subscriptionsCache[o]){var n=e.slice(1),r=new c(t,n,o,this);this._subscriptionsCache[r._fingerprint]=r,this.subscriptions[r.id]=r}return this._subscriptionsCache[o]},i.prototype._reEstablishSubscriptions=function(){var t,e,i=this.subscriptions;for(var o in i)i.hasOwnProperty(o)&&(t=i[o],e=new c(t._name,t._params,t._fingerprint,this),delete this.subscriptions[t.id],delete this._subscriptionsCache[t._fingerprint],this.subscriptions[e.id]=e,this._subscriptionsCache[e._fingerprint]=e)},i.prototype._openOauthPopup=function(t,i,o){var n=this,r=window.open(i,"_blank","location=no,toolbar=no");r.focus&&r.focus();var s=e.defer(),u=JSON.stringify({credentialToken:t}),l=setInterval(function(){r.postMessage(u,n._host)},100);return window.addEventListener("message",function(e){var i;try{i=JSON.parse(e.data)}catch(o){return}e.origin===n._host&&(i.credentialToken===t&&(clearInterval(l),s.resolve({credentialToken:i.credentialToken,credentialSecret:i.credentialSecret})),i.error&&(clearInterval(l),s.reject(i.error)))}),s.promise.then(o.bind(n))},i.utils.multiStorage.get=function(t){var i=e.defer();return i.resolve(localStorage[t]),i.promise},i.utils.multiStorage.set=function(t,i){var o=e.defer();return localStorage[t]=i,o.resolve(),o.promise},i.utils.multiStorage.del=function(t){var i=e.defer();return delete localStorage[t],i.resolve(),i.promise},i.prototype._setDdpOptions=function(t,e,i){this._ddpOptions="function"==typeof SockJS?{endpoint:(e?"https://":"http://")+t+"/sockjs",SocketConstructor:SockJS,socketInterceptFunction:i}:{endpoint:(e?"wss://":"ws://")+t+"/websocket",SocketConstructor:WebSocket,socketInterceptFunction:i}},i});
